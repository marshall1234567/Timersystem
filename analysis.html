<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        .chart-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-box {
            flex: 1 1 45%;
            min-width: 300px;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            margin-right: 15px;
            text-decoration: none;
            color: #0078d7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <a href="timersystem.html">Time System</a>
        </div>
        <h1>Timer Streak Analysis</h1>
        
        <div class="chart-row">
            <div class="chart-box">
                <h3>Streak Length Distribution</h3>
                <div class="chart-container">
                    <canvas id="streak-length-chart"></canvas>
                </div>
            </div>
            <div class="chart-box">
                <h3>Streak Frequency</h3>
                <div class="chart-container">
                    <canvas id="streak-frequency-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get real timer data from localStorage
        function getTimerData() {
            const timerSystemState = JSON.parse(localStorage.getItem('timerSystem')) || { timerUsageData: [] };
            return timerSystemState.timerUsageData || [];
        }

        // Process timer data into streak statistics
        function processStreakData(timerData) {
            const streaks = timerData.filter(item => item.isStreak);
            
            // Group by streak name and calculate stats
            const streakStats = {};
            streaks.forEach(streak => {
                if (!streakStats[streak.name]) {
                    streakStats[streak.name] = {
                        count: 0,
                        totalDuration: 0,
                        sessions: []
                    };
                }
                streakStats[streak.name].count++;
                streakStats[streak.name].totalDuration += streak.duration;
                streakStats[streak.name].sessions.push(streak);
            });

            // Convert to chart data format
            return {
                streakLengths: Object.entries(streakStats).map(([name, stats]) => ({
                    name,
                    length: Math.floor(stats.totalDuration / (1000 * 60 * 60 * 24)), // Convert ms to days
                    count: stats.count
                })),
                streakFrequencies: Object.entries(streakStats).map(([name, stats]) => ({
                    name,
                    length: Math.floor(stats.totalDuration / (1000 * 60 * 60 * 24)),
                    count: stats.sessions.length
                }))
            };
        }

        // Chart instances
        let streakLengthChart, streakFrequencyChart;

        function initializeCharts() {
            const timerData = getTimerData();
            const streakData = processStreakData(timerData);

            // Create or update charts with real data
            streakLengthChart = new Chart(document.getElementById('streak-length-chart'), {
                type: 'bar',
                data: {
                    labels: streakData.streakLengths.map(s => `${s.name} (${s.length} days)`),
                    datasets: [{
                        label: 'Number of Streaks',
                        data: streakData.streakLengths.map(s => s.count),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.raw} for ${streakData.streakLengths[context.dataIndex].name}`
                            }
                        }
                    }
                }
            });

            streakFrequencyChart = new Chart(document.getElementById('streak-frequency-chart'), {
                type: 'bar',
                data: {
                    labels: streakData.streakFrequencies.map(s => `${s.name} (${s.length} days)`),
                    datasets: [{
                        label: 'Frequency',
                        data: streakData.streakFrequencies.map(s => s.count),
                        backgroundColor: 'rgba(255, 99, 132, 0.7)'
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${context.raw} for ${streakData.streakFrequencies[context.dataIndex].name}`
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            const timerData = getTimerData();
            const streakData = processStreakData(timerData);

            // Update streak length chart
            streakLengthChart.data.labels = streakData.streakLengths.map(s => `${s.name} (${s.length} days)`);
            streakLengthChart.data.datasets[0].data = streakData.streakLengths.map(s => s.count);
            streakLengthChart.update();

            // Update streak frequency chart
            streakFrequencyChart.data.labels = streakData.streakFrequencies.map(s => `${s.name} (${s.length} days)`);
            streakFrequencyChart.data.datasets[0].data = streakData.streakFrequencies.map(s => s.count);
            streakFrequencyChart.update();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeCharts();
            
            // Listen for streak completion events
            window.addEventListener('streakCompleted', updateCharts);
            
            // Also keep polling every 30 seconds as backup
            setInterval(updateCharts, 30000);
        });
    </script>
</body>
</html>